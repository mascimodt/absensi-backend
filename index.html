<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistem Absensi Agen Properti</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
<style> body { background:#f8f9fa; } .hidden { display:none !important; } .card { box-shadow:0 2px 8px rgba(0,0,0,0.05); } .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', monospace; } footer{margin-top:1.5rem;color:#666;font-size:.9rem;} </style>
</head>
<body>
<div class="container py-4">
  <div class="row justify-content-center"><div class="col-12 col-md-10 col-lg-9">
    <div id="loginCard" class="card p-4">
      <h3 class="text-center mb-3">Sistem Absensi Agen Properti</h3>
      <div id="loginAlert" class="alert alert-danger d-none"></div>
      <div class="row g-2"><div class="col-md-6"><label>Username</label><input id="loginUsername" class="form-control"></div><div class="col-md-6"><label>Password</label><input id="loginPassword" type="password" class="form-control"></div></div>
      <div class="d-flex gap-2 mt-3"><button id="btnLogin" class="btn btn-primary flex-grow-1">Login</button><button id="btnOpenRegister" class="btn btn-outline-primary">Daftar Anggota Baru</button></div>
      <hr><div class="small-note text-center"><div>Test admin: <span class="mono">admin / admin123</span></div><div>Akun yang mendaftar akan berstatus <strong>Pending</strong>.</div></div>
    </div>

    <div id="registerCard" class="card p-4 hidden">
      <h5>Registrasi</h5>
      <form id="registerForm"><div class="row g-2"><div class="col-md-6"><input id="regName" class="form-control" placeholder="Nama"></div><div class="col-md-6"><input id="regUsername" class="form-control" placeholder="Username"></div><div class="col-md-6"><input id="regEmail" class="form-control" placeholder="Email"></div><div class="col-md-6"><input id="regPassword" type="password" class="form-control" placeholder="Password"></div></div><div id="regError" class="text-danger small mt-2"></div><div class="mt-3"><button class="btn btn-success" type="submit">Daftar</button> <button id="btnCloseRegister" type="button" class="btn btn-secondary">Batal</button></div></form>
    </div>

    <div id="adminCard" class="card p-4 hidden">
      <div class="d-flex justify-content-between"><h4>Dashboard Admin</h4><div><button id="btnExportAll" class="btn btn-sm btn-success">Export Semua</button> <button id="btnAdminLogout" class="btn btn-sm btn-secondary">Logout</button></div></div>
      <hr>
      <h5>Pending Registrations</h5><table id="pendingTable" class="table table-sm"><thead><tr><th>Nama</th><th>Username</th><th>Email</th><th>Aksi</th></tr></thead><tbody></tbody></table>
      <h5>Absensi (Filter)</h5>
      <div class="row g-2 mb-2"><div class="col-md-4"><input id="filterName" class="form-control" placeholder="Cari nama"></div><div class="col-md-3"><input id="filterFrom" type="date" class="form-control"></div><div class="col-md-3"><input id="filterTo" type="date" class="form-control"></div><div class="col-md-2"><button id="btnApplyFilter" class="btn btn-primary">Apply</button></div></div>
      <div style="max-height:300px;overflow:auto"><table id="attendanceTable" class="table table-sm"><thead><tr><th>Nama</th><th>Username</th><th>Status</th><th>Tanggal</th><th>Check-in</th><th>Check-out</th></tr></thead><tbody></tbody></table></div>
    </div>

    <div id="memberCard" class="card p-4 hidden">
      <div class="d-flex justify-content-between"><h4>Dashboard Anggota</h4><div><span id="memberName"></span> <button id="btnMemberLogout" class="btn btn-sm btn-secondary">Logout</button></div></div>
      <div class="mt-3"><button id="btnCheckIn" class="btn btn-primary">Check-in</button> <button id="btnCheckOut" class="btn btn-outline-primary">Check-out</button></div>
      <h6 class="mt-3">Riwayat</h6><div style="max-height:200px;overflow:auto"><table id="memberAttendanceTable" class="table table-sm"><thead><tr><th>Status</th><th>Tanggal</th><th>Check-in</th><th>Check-out</th></tr></thead><tbody></tbody></table></div>
    </div>

  </div></div>
</div>

<script>
const API_BASE = "http://localhost:3000";
const $ = s => document.querySelector(s);
function show(id){ document.querySelectorAll('#loginCard,#registerCard,#adminCard,#memberCard').forEach(e=>e.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }

document.getElementById('btnOpenRegister').addEventListener('click', ()=> show('registerCard'));
document.getElementById('btnCloseRegister').addEventListener('click', ()=> show('loginCard'));

document.getElementById('registerForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const payload = { name: $('#regName').value.trim(), username: $('#regUsername').value.trim(), email: $('#regEmail').value.trim(), password: $('#regPassword').value };
  const res = await fetch(API_BASE+'/auth/register', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
  const j = await res.json();
  if(!res.ok){ $('#regError').innerText = j.error || 'Error'; return; }
  alert(j.message); show('loginCard');
});

document.getElementById('btnLogin').addEventListener('click', async ()=>{
  $('#loginAlert').classList.add('d-none');
  const username = $('#loginUsername').value.trim(); const password = $('#loginPassword').value;
  if(!username||!password){ $('#loginAlert').innerText='Isi username & password'; $('#loginAlert').classList.remove('d-none'); return; }
  const res = await fetch(API_BASE+'/auth/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username,password}) });
  const j = await res.json();
  if(!res.ok){ $('#loginAlert').innerText = j.error || 'Login gagal'; $('#loginAlert').classList.remove('d-none'); return; }
  const role = j.role; const user = j.user;
  localStorage.setItem('currentUser', JSON.stringify(user)); localStorage.setItem('role', role);
  if(role==='admin') initAdmin(); else initMember();
});

async function initAdmin(){
  show('adminCard');
  await loadPending(); await loadAttendance();
}

async function loadPending(){
  const res = await fetch(API_BASE+'/admin/pending-users'); const rows = await res.json();
  const tbody = $('#pendingTable tbody'); tbody.innerHTML='';
  rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.name}</td><td>${r.username}</td><td>${r.email||'-'}</td><td><button data-id="${r.id}" class="approve btn btn-sm btn-success me-1">Approve</button></td>`; tbody.appendChild(tr); });
  document.querySelectorAll('.approve').forEach(btn=> btn.addEventListener('click', async ()=>{ const id=btn.getAttribute('data-id'); await fetch(API_BASE+`/admin/approve-user/${id}`,{method:'PUT'}); loadPending(); }));
}

async function loadAttendance(q=null){
  let url = API_BASE+'/admin/attendance'; if(q) url += '?'+new URLSearchParams(q).toString();
  const res = await fetch(url); const rows = await res.json();
  const tbody = $('#attendanceTable tbody'); tbody.innerHTML='';
  rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.username_name||r.name}</td><td>${r.username}</td><td>${r.status}</td><td>${r.date}</td><td>${r.check_in||'-'}</td><td>${r.check_out||'-'}</td>`; tbody.appendChild(tr); });
}

document.getElementById('btnApplyFilter').addEventListener('click', ()=>{
  const name = $('#filterName').value.trim(); const from = $('#filterFrom').value; const to = $('#filterTo').value;
  const q={}; if(name) q.name=name; if(from) q.from=from; if(to) q.to=to; loadAttendance(q);
});

function fmt(d){ return d?new Date(d).toLocaleString():'-'; }

async function initMember(){
  show('memberCard'); const user = JSON.parse(localStorage.getItem('currentUser')); $('#memberName').innerText = user.name;
  const res = await fetch(API_BASE+`/member/history/${user.username}`); const rows = await res.json();
  const tbody = $('#memberAttendanceTable tbody'); tbody.innerHTML=''; rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.status}</td><td>${r.date}</td><td>${r.check_in||'-'}</td><td>${r.check_out||'-'}</td>`; tbody.appendChild(tr); });
}

document.getElementById('btnCheckIn').addEventListener('click', async ()=>{
  const user = JSON.parse(localStorage.getItem('currentUser')); if(!user) return alert('Login dulu'); const res = await fetch(API_BASE+'/member/checkin',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:user.username})}); const j=await res.json(); if(!res.ok) return alert(j.error||'Error'); alert(j.message); initMember(); loadAttendance();
});

document.getElementById('btnCheckOut').addEventListener('click', async ()=>{
  const user = JSON.parse(localStorage.getItem('currentUser')); if(!user) return alert('Login dulu'); const res = await fetch(API_BASE+'/member/checkout',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:user.username})}); const j=await res.json(); if(!res.ok) return alert(j.error||'Error'); alert(j.message); initMember(); loadAttendance();
});

document.getElementById('btnExportAll').addEventListener('click', ()=>{ window.location = API_BASE+'/admin/export'; });

document.getElementById('btnAdminLogout').addEventListener('click', ()=>{ localStorage.removeItem('currentUser'); localStorage.removeItem('role'); show('loginCard'); });
document.getElementById('btnMemberLogout').addEventListener('click', ()=>{ localStorage.removeItem('currentUser'); localStorage.removeItem('role'); show('loginCard'); });

show('loginCard');
</script>
</body>
</html>
